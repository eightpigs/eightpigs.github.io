

<meta charset="utf-8" />
<meta name="generator" content="Hugo 0.68.1" />

<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="author" content="Eightpigs, eightpigs@outlook.com" />
<meta property="og:url" content="https://eightpigs.io/2019/02/23/upgrade_drone/" />
<link rel="canonical" href="https://eightpigs.io/2019/02/23/upgrade_drone/" />

<link rel="stylesheet" href="/css/github-markdown.css?t=1464395400000">

<link rel="stylesheet" href="/css/head.css?t=1464395400000">
<link rel="stylesheet" href="/css/style.css?t=1464395400000">
<link rel="stylesheet" href="/css/list.css?t=1464395400000">

<title>使用Drone进行持续集成 - Eightpigs</title>
<meta property="og:title" content="使用Drone进行持续集成 - Eightpigs" />
<meta property="og:type" content="article" />
<meta property="og:description" content="介绍 Drone is a Container-Native, Continuous Delivery Platform. Drone 是一个基于容器的持续交付平台。 工作原理 通过Web Hook接受相关事件（推送、创建分支、合并请求等&hellip;) 读取并" />
<meta name="description" content="介绍 Drone is a Container-Native, Continuous Delivery Platform. Drone 是一个基于容器的持续交付平台。 工作原理 通过Web Hook接受相关事件（推送、创建分支、合并请求等&hellip;) 读取并" />
<meta name="keywords" content="IT,Java,Go,Web,Programmer,Algorithm" />

<link rel="stylesheet" href="/css/highlight/gruvbox-light.css">

<link rel="stylesheet" href="/css/post.css?t=1464395400000">




<div class="content markdown-body">
  <h1>使用Drone进行持续集成 </h1>
  <div class="info">
    <span class="date">
      2019-02-23
    </span>

    
      
      <span class="categories">
      
      <a data-real="Develop" href="/categories/develop/" class="category">
        开发和实践
      </a>
      ‣
      </span>
    
    
    <span class="tags">
      
      <a data-real="Go" href="/tags/go/" class="tag">#Go</a>
      
      <a data-real="CI" href="/tags/ci/" class="tag">#CI</a>
      
      <a data-real="Docker" href="/tags/docker/" class="tag">#Docker</a>
      
      <a data-real="Docker Compose" href="/tags/docker-compose/" class="tag">#Docker Compose</a>
      
    </span>
  </div>
  </h1>

  
  <div class="changelogs">
    <div class="title">更新日志</div>
    
      
      <div class="changelog">
        <span class="time">2019-07-20</span>
        <span class="note">更新所属分类</span>
      </div>
      
    
  </div>
  

  <h2 id="介绍">介绍</h2>
<blockquote>
<p>Drone is a Container-Native, Continuous Delivery Platform.
Drone 是一个基于容器的持续交付平台。</p>
</blockquote>
<h2 id="工作原理">工作原理</h2>
<ol>
<li>通过Web Hook接受相关事件（推送、创建分支、合并请求等&hellip;)</li>
<li>读取并执行该仓库根目录下的.drone.yaml文件</li>
</ol>
<h2 id="特性">特性</h2>
<ol>
<li>支持多种仓库类型（GitHub, GitLab, Gitea, Gogs, Bitbucket Cloud, Bitbucket Server）</li>
<li>支持插件</li>
<li>支持分布式构建</li>
<li>支持多操作系统构建</li>
<li>基于Docker</li>
<li>基于Go语言</li>
</ol>
<h2 id="安装">安装</h2>
<p><a href="https://cloud.drone.io/drone/hello-world">Demo 地址</a></p>
<p>使用Drone进行持续集成已经8个月了，因为功能基本满足我的需求，所以一直停留在0.8版本。今天正好有时间，遂打算升级到1.0.0版本并记录下Drone的升级+使用。</p>
<p>我一直使用 Docker Compose 运行Drone，本文也将主要讲基于Docker Compose升级启动过程。在配置中，我以集成Gogs为例，要集成其他其他平台（如Github、GitLab）配置也很简单，具体请参照官网的 <strong>Installation Guide</strong> 下的各平台配置说明。</p>
<p>1.0版本与0.8版本不兼容，需要修改各个配置项的名称，在1.0版本找到对应的配置名称即可。</p>
<ul>
<li><a href="https://docs.drone.io/reference/server/">drone-server 配置项文档</a></li>
<li><a href="https://docs.drone.io/reference/agent/">drone-agent  配置项文档</a></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># file name: docker-compose.yaml</span>

<span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#39;2&#39;</span>

<span style="color:#66d9ef">services</span>:

  <span style="color:#66d9ef">drone-server</span>:
    <span style="color:#66d9ef">image</span>: drone/drone:<span style="color:#ae81ff">1.0.0</span>-rc<span style="color:#ae81ff">.5</span>  <span style="color:#75715e"># 使用最新的版本</span>
    <span style="color:#66d9ef">ports</span>:
      - <span style="color:#e6db74">&#34;8888:80&#34;</span>                   <span style="color:#75715e"># web 访问的端口</span>
      - <span style="color:#ae81ff">9000</span>                        <span style="color:#75715e"># 用于与drone-agent通信</span>
    <span style="color:#66d9ef">volumes</span>:
      - /data/drone:/var/lib/drone/               <span style="color:#75715e"># 持久化到宿主的/data/drone目录下</span>
      - /var/run/docker.sock:/var/run/docker.sock <span style="color:#75715e"># 与docker进行通信</span>
    <span style="color:#66d9ef">restart</span>: <span style="color:#e6db74">&#34;always&#34;</span>
    <span style="color:#66d9ef">environment</span>:
      - DRONE_GIT_ALWAYS_AUTH=<span style="color:#66d9ef">false</span>
      - DRONE_GOGS_SERVER=http://gogs.admin.com  <span style="color:#75715e"># 集成gogs</span>
      - DRONE_RUNNER_CAPACITY=<span style="color:#ae81ff">2</span>
      - DRONE_SERVER_HOST=drone.admin.com
      - DRONE_SERVER_PROTO=https
      - DRONE_RPC_SECRET=da19cfd2-33ed-44d2<span style="color:#ae81ff">-8e60</span>-5c987e780f36
      - DRONE_USER_CREATE=username:zhangsan,admin:<span style="color:#66d9ef">true</span> <span style="color:#75715e"># 设置用户zhangsan为管理员</span>
      - DRONE_LOGS_DEBUG=<span style="color:#66d9ef">true</span>

  <span style="color:#66d9ef">drone-agent</span>:
    <span style="color:#66d9ef">image</span>: drone/agent:<span style="color:#ae81ff">1.0.0</span>-rc<span style="color:#ae81ff">.5</span>
    <span style="color:#66d9ef">restart</span>: <span style="color:#e6db74">&#34;always&#34;</span>
    <span style="color:#66d9ef">depends_on</span>:
      - drone-server
    <span style="color:#66d9ef">volumes</span>:
      - /var/run/docker.sock:/var/run/docker.sock <span style="color:#75715e"># 与docker进行通信</span>
    <span style="color:#66d9ef">environment</span>:
      - DRONE_RPC_SERVER=drone-server:<span style="color:#ae81ff">9000</span> <span style="color:#75715e"># 连接到drone-server服务</span>
      - DRONE_RPC_SECRET=da19cfd2-33ed-44d2<span style="color:#ae81ff">-8e60</span>-5c987e780f36 <span style="color:#75715e"># 与drone-server保持一致 </span>
      - DRONE_LOGS_DEBUG=<span style="color:#66d9ef">true</span>
</code></pre></div><hr>
<p>执行 <strong>docker-compose up</strong> 启动server和agent，启动完成后可以访问在配置中指定的地址进入后台管理，由于前面配置了Gogs集成，所以登录的帐号和密码均是Gogs的帐号和密码。</p>
<p>每个项目的设置界面分为4个设置区域：Main、Secrets、Cron Jobs、Badges。</p>
<p><strong>注意</strong>：_如果该项目的Project Settings 一栏没有 <strong>Trusted</strong> 选项，代表在Docker Compose的启动配置中未将当前登录用户设置为Drone的管理员。若项目不设置为 <strong>Trusted</strong>，则不能进行构建。</p>
<p><img src="drone-settings.png" alt="drone settings"></p>
<hr>
<p>具体构建详情，其中，左边列出了构建步骤，点击可以查看各个构建步骤的详细日志。</p>
<p><img src="drone-pipeline.png" alt="drone pipeline"></p>
<h2 id="构建配置">构建配置</h2>
<p>项目的构建配置在官网给出了详细的示例：</p>
<ul>
<li><a href="https://docs.drone.io/examples/language/">Language Examples</a></li>
<li><a href="https://docs.drone.io/examples/service/">Service Examples</a></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># node构建并挂载目录的示例</span>

<span style="color:#66d9ef">kind</span>: pipeline
<span style="color:#66d9ef">name</span>: default

<span style="color:#66d9ef">steps</span>:
- <span style="color:#66d9ef">name</span>: build
  <span style="color:#66d9ef">image</span>: node:<span style="color:#ae81ff">8</span>-alpine  <span style="color:#75715e"># 使用 node:8-alpine 镜像</span>
  <span style="color:#66d9ef">volumes</span>:              <span style="color:#75715e"># 挂载目录</span>
    - <span style="color:#66d9ef">name</span>: volData
      <span style="color:#66d9ef">path</span>: /data/
  <span style="color:#66d9ef">commands</span>:             <span style="color:#75715e"># 所有linux命令（正确说法是：镜像所支持的所有命令）</span>
    - npm install
    - npm test
    - ls -als /data/
    - echo Hello

<span style="color:#75715e"># 挂载目录的具体配置</span>
<span style="color:#66d9ef">volumes</span>: 
  - <span style="color:#66d9ef">name</span>: volData
    <span style="color:#66d9ef">host</span>:
      <span style="color:#66d9ef">path</span>: /data/
</code></pre></div>

  
    <br />
    <br />
    <hr />
    文章作者：eightpigs
    <br />
    创作时间：2019-02-23
    <br />
    更新时间：
    
      2019-03-04
    
    <br />
    许可协议：<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" class="cc">CC by-nc-nd 4.0</a>
    <hr />
  
</div>

<script charset="utf-8">
  encode("tag")
  encode("category")
  function encode(ele) {
    var elems = document.getElementsByClassName(ele)
    if (elems) {
      for (var i=0; i < elems.length; i++) {
        var id = elems[i].getAttribute("data-real")
        var href = elems[i].getAttribute("href")
        if (href && id) {
          id = id.toLowerCase()
          if (href.indexOf(id) != -1) {
            elems[i].setAttribute("href",  href.replace(id, encodeURIComponent(id)));
          }
        }
      }
    }
  }
</script>



<div class="footer">
  
  <div class="copyright">&copy; 2014 - 
    
      2020

    
      Eightpigs 
  </div>
  
  <div class="navbar">
  <ul>
  
    <li>
      <a href="/">首页</a>
    </li>
  
    <li>
      <a href="/archives">归档</a>
    </li>
  
    <li>
      <a href="/pages/about">关于</a>
    </li>
  
  </ul>
</div>

</div>


<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
 


  


  


  


